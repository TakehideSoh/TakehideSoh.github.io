<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-26 金 14:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scarab チュートリアル</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Takehide Soh" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-6313627-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-6313627-5');
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/sticky-table-headers"></script>
<link rel="stylesheet" type="text/css" href="https://tsoh.org/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://tsoh.org/css/readtheorg.css"/>
<script type="text/javascript" src="https://tsoh.org/scarab/js/readtheorg.js"></script>
<style type="text/css">
<!--/*--><![CDATA[/*><!--*/
#content { max-width: 1200px; }
/*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Scarab チュートリアル</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org88189cd">1. 参考資料</a></li>
<li><a href="#org7b8a5d4">2. インストール (sbt)</a></li>
<li><a href="#orgff7b420">3. 実行の方法</a></li>
<li><a href="#org6249ac8">4. REPL による対話的な実行方法</a>
<ul>
<li><a href="#org03f1837">4.1. CSP の定義</a></li>
<li><a href="#org176c22c">4.2. 解の探索</a></li>
</ul>
</li>
<li><a href="#orgfb05dc0">5. スクリプトファイルの読み込み</a>
<ul>
<li><a href="#orgb56e71a">5.1. 練習問題</a></li>
</ul>
</li>
<li><a href="#orgd1f6df1">6. 簡単な例題</a>
<ul>
<li><a href="#orgd262e04">6.1. 部分和問題</a></li>
<li><a href="#orgad5e6e9">6.2. 魔方陣</a></li>
<li><a href="#org0c8eb9c">6.3. 正方形矩形パッキング</a></li>
<li><a href="#org0f7a55f">6.4. その他の例題</a></li>
</ul>
</li>
<li><a href="#orge3f4ad9">7. その他 Scarab の説明クラスとメソッドの簡単なまとめ</a>
<ul>
<li><a href="#orgc01db61">7.1. jar ファイルとソースコード</a></li>
<li><a href="#orgda479fe">7.2. Scarab のクラスについて</a></li>
<li><a href="#org5be2710">7.3. Scarab DSL について</a></li>
<li><a href="#org37a4d3e">7.4. Scarab DSL の制約記述に関する構文 (BNF記法)</a></li>
<li><a href="#org8a2d1ed">7.5. プログラムの簡単なまとめ</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org88189cd" class="outline-2">
<h2 id="org88189cd"><span class="section-number-2">1</span> 参考資料</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Scarab 資料
<ul class="org-ul">
<li><a href="http://tsoh.org/scarab/">ホームページ</a></li>
<li><a href="https://github.com/TakehideSoh/Scarab">github</a></li>
</ul></li>
<li>プレゼンテーション
<ul class="org-ul">
<li>Scarab の説明 @ ScalaMatsuri 2014
<ul class="org-ul">
<li><a href="https://tsoh.org/scarab/talks/talk-jp-scalamatsuri.pdf">日本語</a></li>
<li><a href="https://tsoh.org/scarab/talks/talk-en-scalamatsuri.pdf">英語</a></li>
</ul></li>
<li>AIツールセミナー (2015年12月)
<ul class="org-ul">
<li><a href="https://tsoh.org/scarab/talks/ai-tool-soh-1.pdf">SAT型制約ソルバーと Scarab</a></li>
<li><a href="https://tsoh.org/scarab/talks/ai-tool-soh-2.pdf">alldiffrent制約を例に用いた制約の拡張</a></li>
</ul></li>
<li><a href="https://tsoh.org/scarab/talks/talk-jp-ppl2017.pdf">SATソルバーの最新動向と利用技術 (日本語) @ PPL 2017</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org7b8a5d4" class="outline-2">
<h2 id="org7b8a5d4"><span class="section-number-2">2</span> インストール (sbt)</h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li><a href="https://www.scala-sbt.org/1.x/docs/ja/Setup.html">sbt 本家</a> のインストールマニュアルをみて，sbt のインストールを行う.
以下の環境へのインストール方法が記載されている. 
<ul class="org-ul">
<li><a href="https://www.scala-sbt.org/1.x/docs/ja/Installing-sbt-on-Mac.html">Mac へのインストール方法</a></li>
<li><a href="https://www.scala-sbt.org/1.x/docs/ja/Installing-sbt-on-Windows.html">Windows へのインストール方法</a>
<ul class="org-ul">
<li>ただし，Windows に関しては sbt 本家サイトの方法だと環境変数の設
定が必要になるので, パッケージ管理ソフト chocolatey を使う<a href="https://tsoh.org/misc/scala-install.html">この方法</a>
がおすすめ．</li>
</ul></li>
<li><a href="https://www.scala-sbt.org/1.x/docs/ja/Installing-sbt-on-Linux.html">Linux へのインストール方法</a></li>
<li>念のため, 上記のページを参考に Windows 10, Ubuntu 18.04, Mac OS X
10.11.6 にインストールした方法を <a href="https://tsoh.org/misc/scala-install.html">ここ</a> に記載する.</li>
</ul></li>
<li><a href="./sbt-scarab.zip">sbt-scarab.zip</a> をダウンロードして適当なディレクトリに展開する．</li>
<li><p>
sbt-scarab のディレクトリに入って sbt を実行すれば必要なライブラリ
(scala を含む) のダウンロードとコンパイルが行われる (初回は結構時間
がかかる)．
</p>
<div class="org-src-container">
<pre class="src src-sh">[sbt-scarab]$ sbt 
</pre>
</div></li>
<li><p>
以下のように sbt:Scarab&gt; というプロンプトが出てくる. 
</p>
<div class="org-src-container">
<pre class="src src-sh">[sbt-scarab]$ sbt
[info] Loading settings from assembly.sbt ...
... &#20013;&#30053; ...
[info] sbt server started at 127.0.0.1:4891
sbt:Scarab&gt; 
</pre>
</div></li>
<li><p>
以下のように console を実行する (初回は結構時間がかかる). 
</p>
<div class="org-src-container">
<pre class="src src-sh">sbt:Scarab&gt; console
</pre>
</div></li>
<li><p>
以下のように scala というプロンプトが出てくれば sbt および scarab
のインストール完了．
</p>
<div class="org-src-container">
<pre class="src src-sh">scala&gt; 
</pre>
</div></li>
<li><p>
:quit で終了できる．
</p>
<div class="org-src-container">
<pre class="src src-sh">scala&gt; :quit
[sbt-scarab]$ 
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-orgff7b420" class="outline-2">
<h2 id="orgff7b420"><span class="section-number-2">3</span> 実行の方法</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Scarab の制約記述言語は Scala 上のドメイン特化言語として実装されている． <a href="ref.html">Scala の説明</a></li>
<li>Scala と同じく3つの方法でプログラムを記述し，実行できる．
<ul class="org-ul">
<li>REPL (Read Eval Print Loop) による対話的な実行方法</li>
<li>スクリプトによるコンパイル不要な実行方法</li>
<li>scalac で実行形式にコンパイルしてから実行する方法</li>
<li><a href="https://almond.sh/">Almond</a> Scala カーネル上の <a href="http://jupyter.org/">jupyter notebook</a> で実行する
<ul class="org-ul">
<li>環境設定無しで, ブラウザだけで実行できます.</li>
<li><a href="https://mybinder.org/v2/gh/TakehideSoh/Scarab4Binder/master?urlpath=lab/tree/index.ipynb">ここ</a> をクリックしてもらうだけで，少し待つと実行環境が表示されます．</li>
</ul></li>
</ul></li>
<li>本チュートリアルでは REPL による対話的な実行方法を通して scarab を説明する．</li>
</ul>
</div>
</div>

<div id="outline-container-org6249ac8" class="outline-2">
<h2 id="org6249ac8"><span class="section-number-2">4</span> REPL による対話的な実行方法</h2>
<div class="outline-text-2" id="text-4">
<p>
簡単な例題を通して, Scala の REPL (対話的実行環境) を用いた scarab の利用方法を理解しよう.
</p>
<pre class="example">
=== 問題 ===
12セント，16セント，20セント，27セントの切手をそれぞれ10枚持っている．
この時に90セント分の切手を構成できるか?
</pre>
<p>
この問題は以下のように制約充足問題 (CSP) として定義できる．
</p>
<blockquote id="test">
<p>
<code>=</code> 切手の問題の CSP による定義 <code>=</code>
</p>
<ul class="org-ul">
<li>変数の集合 \(X = \{a, b, c, d\}\)</li>
<li>変数が取り得る値の集合 (ドメイン) を表す関数 \(Dom\)
<ul class="org-ul">
<li>\(Dom(a) = \{0, \ldots, 10\}\)</li>
<li>\(Dom(b) = \{0, \ldots, 10\}\)</li>
<li>\(Dom(c) = \{0, \ldots, 10\}\)</li>
<li>\(Dom(d) = \{0, \ldots, 10\}\)</li>
</ul></li>
<li>制約条件 \(C\)
<ul class="org-ul">
<li>\(12a + 16b + 20c + 27d = 90\)</li>
</ul></li>
</ul>
</blockquote>
</div>

<div id="outline-container-org03f1837" class="outline-3">
<h3 id="org03f1837"><span class="section-number-3">4.1</span> CSP の定義</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>上記のCSPに対応するScarabプログラムは以下になる</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span>

int(<span style="color: #8b2252;">'a</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'b</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'c</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'d</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)

add(<span style="color: #8b2252;">'a</span> * <span style="color: #008b8b;">12</span> + <span style="color: #8b2252;">'b</span> * <span style="color: #008b8b;">16</span> + <span style="color: #8b2252;">'c</span> * <span style="color: #008b8b;">20</span> + <span style="color: #8b2252;">'d</span> * <span style="color: #008b8b;">27</span> === <span style="color: #008b8b;">90</span>)
</pre>
</div>
<ul class="org-ul">
<li>このプログラムを REPL (対話的な実行方法) で記述実行するために, sbt-scarab ディレクトリで sbt コマンド実行後に, console を実行する. すると最終的に scala&gt; というコンソールが立ち上げる.</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">[sbt-scarab]$ sbt
sbt:Scarab&gt; console
... &#12513;&#12483;&#12475;&#12540;&#12472;&#30465;&#30053; ...
scala&gt; 
</pre>
</div>
<ul class="org-ul">
<li>これで scala の REPL モードが scarab のクラスを読み込んで起動された．</li>
<li>次に scarab のクラスをインポートする.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> dsl.<span style="color: #a020f0;">_</span>
</pre>
</div>
<ul class="org-ul">
<li>import 文が読み込まれ (Read Eval) 実行結果が表示 (Print) される.</li>
<li>整数変数を定義する.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; int(<span style="color: #8b2252;">'a</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
res0<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> a

scala&gt; int(<span style="color: #8b2252;">'b</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
res1<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> b

scala&gt; int(<span style="color: #8b2252;">'c</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
res2<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> c

scala&gt; int(<span style="color: #8b2252;">'d</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
res3<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> d      
</pre>
</div>
<ul class="org-ul">
<li>ここでは変数a, b, c, dを宣言している (下限 0，上限 10)． シングルクォーテーションから始まる記述 &rsquo;x は ScalaにおけるSymbolオブジェクトの記法だが， Scarab DSLによりScarabの整数変数 (Varオブジェクト) に暗黙変換される.</li>
<li>制約を定義する.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; add(<span style="color: #8b2252;">'a</span> * <span style="color: #008b8b;">12</span> + <span style="color: #8b2252;">'b</span> * <span style="color: #008b8b;">16</span> + <span style="color: #8b2252;">'c</span> * <span style="color: #008b8b;">20</span> + <span style="color: #8b2252;">'d</span> * <span style="color: #008b8b;">27</span> === <span style="color: #008b8b;">90</span>)
res4<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-90</span>+<span style="color: #008b8b;">12</span>*a+<span style="color: #008b8b;">16</span>*b+<span style="color: #008b8b;">20</span>*c+<span style="color: #008b8b;">27</span>*d))
</pre>
</div>
<ul class="org-ul">
<li>ここでは制約 12a + 16b + 20c + 27d = 90 を追加している. 
<ul class="org-ul">
<li>add は制約をCSPオブジェクトに追加するためのメソッドである.</li>
<li>制約中での等号に \(===\) を用いる点に注意されたい.</li>
<li>5 * &rsquo;a のように係数を前にして記述できない点にも注意されたい.</li>
</ul></li>
<li>定義したCSPオブジェクトは変数cspとして参照できる.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; csp
res8<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">CSP</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">CSP</span>(<span style="color: #008b8b;">Vector</span>(a, b, c, d),<span style="color: #008b8b;">Vector</span>(),<span style="color: #008b8b;">Map</span>(..),<span style="color: #008b8b;">Vector</span>(..))
</pre>
</div>
<ul class="org-ul">
<li>CSPオブジェクトは，整数変数の列 variables, ブール変数の列 bools,
変数ドメインのマップ dom, 制約の列 constraints から構成される.</li>
<li>以下のように csp オブジェクトから参照できる.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; csp.variables
res5<span style="color: #a020f0;">:</span> <span style="color: #228b22;">IndexedSeq</span>[jp.kobe_u.scarab.<span style="color: #008b8b;">Var</span>] <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Vector</span>(a, b, c, d)

scala&gt; csp.constraints
res6<span style="color: #a020f0;">:</span> <span style="color: #228b22;">IndexedSeq</span>[jp.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span>] <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Vector</span>(<span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-90</span>+<span style="color: #008b8b;">12</span>*a+<span style="color: #008b8b;">16</span>*b+<span style="color: #008b8b;">20</span>*c+<span style="color: #008b8b;">27</span>*d)))
</pre>
</div>
<ul class="org-ul">
<li>show メソッドでも表示できる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; csp.show
int(a,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(b,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(c,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(d,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
<span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-90</span>+<span style="color: #008b8b;">12</span>*a+<span style="color: #008b8b;">16</span>*b+<span style="color: #008b8b;">20</span>*c+<span style="color: #008b8b;">27</span>*d))      
</pre>
</div>
<ul class="org-ul">
<li>CSPオブジェクトは，変数や制約の追加を行える mutable なオブジェクトとして実装されている．</li>
</ul>
</div>
</div>

<div id="outline-container-org176c22c" class="outline-3">
<h3 id="org176c22c"><span class="section-number-3">4.2</span> 解の探索</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>最初の解の探索は find で行う．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; find
res9<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">true</span>
</pre>
</div>
<ul class="org-ul">
<li>結果の true は，解が存在することを表す． CSPの解は，solution 変数に代入されている．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; solution
res10<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Assignment</span>(<span style="color: #008b8b;">Map</span>(a -&gt; <span style="color: #008b8b;">3</span>, b -&gt; <span style="color: #008b8b;">0</span>, c -&gt; <span style="color: #008b8b;">0</span>, d -&gt; <span style="color: #008b8b;">2</span>),<span style="color: #008b8b;">Map</span>())
</pre>
</div>
<ul class="org-ul">
<li>Solutionオブジェクトは，整数変数 (Varオブジェクト)に対する値割当てを表すマップと ブール変数 (Boolオブジェクト)に対する値割当てを表すマップから構成される．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; solution.intMap
res11<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Map</span>[jp.kobe_u.scarab.<span style="color: #008b8b;">Var</span>,<span style="color: #008b8b;">Int</span>] <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Map</span>(a -&gt; <span style="color: #008b8b;">3</span>, b -&gt; <span style="color: #008b8b;">0</span>, c -&gt; <span style="color: #008b8b;">0</span>, d -&gt; <span style="color: #008b8b;">2</span>)

scala&gt; solution.boolMap
res12<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Map</span>[jp.kobe_u.scarab.<span style="color: #008b8b;">Bool</span>,<span style="color: #008b8b;">Boolean</span>] <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Map</span>()
</pre>
</div>
<ul class="org-ul">
<li>解における各変数の値は solution メソッドで得ることができる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; solution(<span style="color: #8b2252;">'a</span>)
res13<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">3</span>

scala&gt; solution(<span style="color: #8b2252;">'b</span>)
res14<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">0</span>

scala&gt; solution(<span style="color: #8b2252;">'c</span>)
res15<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">0</span>

scala&gt; solution(<span style="color: #8b2252;">'d</span>)
res16<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">2</span>     
</pre>
</div>
<ul class="org-ul">
<li>次の解の探索は findNext で行う．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; findNext
res17<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">true</span>

scala&gt; solution
res18<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Assignment</span>(<span style="color: #008b8b;">Map</span>(a -&gt; <span style="color: #008b8b;">0</span>, b -&gt; <span style="color: #008b8b;">1</span>, c -&gt; <span style="color: #008b8b;">1</span>, d -&gt; <span style="color: #008b8b;">2</span>),<span style="color: #008b8b;">Map</span>())
</pre>
</div>
<ul class="org-ul">
<li>findNext は最も最近得られた解の否定をcspに追加することで次の解を求めている．</li>
<li>show メソッドを実行すると，制約が追加されていることが分かる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">int(a,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(b,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(c,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(d,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-90</span>+<span style="color: #008b8b;">12</span>*a+<span style="color: #008b8b;">16</span>*b+<span style="color: #008b8b;">20</span>*c+<span style="color: #008b8b;">27</span>*d))
<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">90-12</span>*a-16*b-20*c-27*d))
<span style="color: #008b8b;">Or</span>(<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-2</span>+a)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">4</span>-a)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">1</span>+b)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">1</span>-b)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">1</span>+c)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">1</span>-c)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-1</span>+d)),<span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">3</span>-d)))     
</pre>
</div>
<ul class="org-ul">
<li>ここでこの次の解の探索時には，最初に解を求めた時の学習節を再利用するインクリメンタルSAT解法を行っている．</li>
<li>Scarab では明示的にSATソルバーを reset しない限り，常に学習節を保持して効率的に求解を行う．</li>
<li>もう一度 findNext を呼ぶと false が返る．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; findNext
res22<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">false</span>     
</pre>
</div>
<ul class="org-ul">
<li>結果の false は，解が存在しないことを表す． この場合，変数 solution は null になっている．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; solution
res23<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">null</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfb05dc0" class="outline-2">
<h2 id="orgfb05dc0"><span class="section-number-2">5</span> スクリプトファイルの読み込み</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>CSPをScalaのスクリプトファイルとして定義することもできる．</li>
<li>以下がCSPを定義したスクリプトファイルである.
<ul class="org-ul">
<li><a href="http://tsoh.org/scarab/sample-scripts/ex-csp.sc">http://tsoh.org/scarab/sample-scripts/ex-csp.sc</a></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span>

int(<span style="color: #8b2252;">'a</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'b</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'c</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'d</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
add(<span style="color: #8b2252;">'a</span> * <span style="color: #008b8b;">12</span> + <span style="color: #8b2252;">'b</span> * <span style="color: #008b8b;">16</span> + <span style="color: #8b2252;">'c</span> * <span style="color: #008b8b;">20</span> + <span style="color: #8b2252;">'d</span> * <span style="color: #008b8b;">27</span> === <span style="color: #008b8b;">90</span>)
</pre>
</div>
<ul class="org-ul">
<li>以下がCSPを定義した後に求解し，解があれば出力するスクリプトファイルである.
<ul class="org-ul">
<li><a href="http://tsoh.org/scarab/sample-scripts/ex-csp-solve.sc">http://tsoh.org/scarab/sample-scripts/ex-csp-solve.sc</a></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span>

int(<span style="color: #8b2252;">'a</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'b</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'c</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
int(<span style="color: #8b2252;">'d</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
add(<span style="color: #8b2252;">'a</span> * <span style="color: #008b8b;">12</span> + <span style="color: #8b2252;">'b</span> * <span style="color: #008b8b;">16</span> + <span style="color: #8b2252;">'c</span> * <span style="color: #008b8b;">20</span> + <span style="color: #8b2252;">'d</span> * <span style="color: #008b8b;">27</span> === <span style="color: #008b8b;">90</span>)

<span style="color: #a020f0;">if</span> (find) println(solution)
</pre>
</div>

<ul class="org-ul">
<li>スクリプトファイルは以下のようにREPLから :load コマンドを使用して読
み込む (カレントディレクトリにファイルがあるものとする)．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">:</span><span style="color: #228b22;">load</span> ./ex-csp.sc
<span style="color: #008b8b;">Loading</span> ./ex-csp.sc...
<span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> dsl.<span style="color: #a020f0;">_</span>
res0<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> a
res1<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> b
res2<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> c
res3<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> d
res4<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-90</span>+<span style="color: #008b8b;">12</span>*a+<span style="color: #008b8b;">16</span>*b+<span style="color: #008b8b;">20</span>*c+<span style="color: #008b8b;">27</span>*d))
</pre>
</div>
<ul class="org-ul">
<li>スクリプトファイルの内容を変更した後，再度読み込みたい場合には，:load の前に reset (scarab のコマンド) を実行し，いったんCSPの定義を消去する必要がある．</li>
</ul>

<div class="org-src-container">
<pre class="src src-scala">scala&gt; reset

scala&gt; <span style="color: #a020f0;">:</span><span style="color: #228b22;">load</span> ./ex-csp.sc
<span style="color: #008b8b;">Loading</span> ./ex-csp.sc...
<span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> dsl.<span style="color: #a020f0;">_</span>
res13<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> a
res14<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> b
res15<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> c
res16<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> d
res17<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-90</span>+<span style="color: #008b8b;">12</span>*a+<span style="color: #008b8b;">16</span>*b+<span style="color: #008b8b;">20</span>*c+<span style="color: #008b8b;">27</span>*d))
</pre>
</div>
</div>

<div id="outline-container-orgb56e71a" class="outline-3">
<h3 id="orgb56e71a"><span class="section-number-3">5.1</span> 練習問題</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>89円分の切手を構成できるかテストしてみよう．</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd1f6df1" class="outline-2">
<h2 id="orgd1f6df1"><span class="section-number-2">6</span> 簡単な例題</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgd262e04" class="outline-3">
<h3 id="orgd262e04"><span class="section-number-3">6.1</span> 部分和問題</h3>
<div class="outline-text-3" id="text-6-1">
<pre class="example">
使いきらなければならない予算が 50 千円あります．
購入できる品物は 2, 3, 5, 8, 13, 21, 34 (単位: 千円) が1つずつです．
ちょうど予算を使い切るような組合せはあるか?
</pre>

<ul class="org-ul">
<li>この問題は 部分和問題 (Subset sum problem)として知られている問題の例である． 部分和問題はNP-完全である (<a href="https://ja.wikipedia.org/wiki/%E9%83%A8%E5%88%86%E5%92%8C%E5%95%8F%E9%A1%8C">Wikipedia:部分和問題</a>)．</li>
<li>これは，以下の制約充足問題として定式化できる．</li>
</ul>
<blockquote>
<ul class="org-ul">
<li>\(X = \{x_2, x_3, x_5, x_8, x_{13}, x_{21}, x_{34}\}\)</li>
<li>\(Dom\)
<ul class="org-ul">
<li>\(Dom(x_2) = \{0, 1\}\)</li>
<li>\(Dom(x_3) = \{0, 1\}\)</li>
<li>\(Dom(x_5) = \{0, 1\}\)</li>
<li>\(Dom(x_8) = \{0, 1\}\)</li>
<li>\(Dom(x_{13}) = \{0, 1\}\)</li>
<li>\(Dom(x_{21}) = \{0, 1\}\)</li>
<li>\(Dom(x_{34}) = \{0, 1\}\)</li>
</ul></li>
<li>\(C\)
<ul class="org-ul">
<li>\(2x_2 + 3x_3 + 5x_5 + 8x_8 + 13x_{13} + 21x_{21} + 34x_{34} = 50\)</li>
</ul></li>
</ul>
</blockquote>
<ul class="org-ul">
<li>CSPを記述したファイルは以下のようになる <a href="https://tsoh.org/scarab/sample-scripts/ex-subsetsum.sc">ex-subsetsum.sc</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span> 

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">define</span>(sum<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span>) {
  reset
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>))
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">3</span>))
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">5</span>))
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">8</span>))
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">13</span>))
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">21</span>))
  boolInt(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">34</span>))
  add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>)*<span style="color: #008b8b;">2</span> + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">3</span>)*<span style="color: #008b8b;">3</span> + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">5</span>)*<span style="color: #008b8b;">5</span> + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">8</span>)*<span style="color: #008b8b;">8</span> + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">13</span>)*<span style="color: #008b8b;">13</span> + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">21</span>)*<span style="color: #008b8b;">21</span> + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">34</span>)*<span style="color: #008b8b;">34</span> === sum)
}
</pre>
</div>

<ul class="org-ul">
<li>boolInt は 0-1 変数の宣言であり， boolInt(x) は int(x, 0, 1) と同一である．</li>
<li>また上記プログラムでは，直接CSPを記述するのではなく， 関数 define(sum: Int) で和を与えられるようにしている． この場合，利用方法は以下のようになる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">:</span><span style="color: #228b22;">load</span> ./ex-subsetsum.sc
<span style="color: #008b8b;">Loading</span> ./ex-subsetsum.sc...
<span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> dsl.<span style="color: #a020f0;">_</span>
define<span style="color: #a020f0;">:</span> (sum<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span>)<span style="color: #008b8b;">Unit</span>

scala&gt; define(<span style="color: #008b8b;">50</span>)

scala&gt; find
res1<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">true</span>

scala&gt; solution
res2<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Assignment</span>(<span style="color: #008b8b;">Map</span>(x(<span style="color: #008b8b;">8</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">21</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">3</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">13</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">2</span>) -&gt; <span style="color: #008b8b;">0</span>, x(<span style="color: #008b8b;">34</span>) -&gt; <span style="color: #008b8b;">0</span>, x(<span style="color: #008b8b;">5</span>) -&gt; <span style="color: #008b8b;">1</span>),<span style="color: #008b8b;">Map</span>())
</pre>
</div>
<ul class="org-ul">
<li>解が見にくいが，以下のようにすれば見やすくなる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">for</span> (x <span style="color: #a020f0;">&lt;-</span> csp.variables) println(s<span style="color: #8b2252;">"</span><span style="color: #a0522d;">$x</span><span style="color: #8b2252;"> </span><span style="color: #a0522d;">${solution(x)}</span><span style="color: #8b2252;">"</span>)
x(<span style="color: #008b8b;">2</span>) <span style="color: #008b8b;">0</span>
x(<span style="color: #008b8b;">3</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">5</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">8</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">13</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">21</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">34</span>) <span style="color: #008b8b;">0</span>
</pre>
</div>
<ul class="org-ul">
<li>この解は 3, 5, 8, 13, 21 (単位: 千円) の品物を買えば 50 千円になることを表している．</li>
<li>34 千円の品物が入った解が欲しい場合は，以下のように制約を追加して解を求めれば良い．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">34</span>) === <span style="color: #008b8b;">1</span>)
res6<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-1</span>+x(<span style="color: #008b8b;">34</span>)))

scala&gt; find
res7<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">true</span>

scala&gt; solution
res8<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Assignment</span>(<span style="color: #008b8b;">Map</span>(x(<span style="color: #008b8b;">8</span>) -&gt; <span style="color: #008b8b;">0</span>, x(<span style="color: #008b8b;">21</span>) -&gt; <span style="color: #008b8b;">0</span>, x(<span style="color: #008b8b;">3</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">13</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">2</span>) -&gt; <span style="color: #008b8b;">0</span>, x(<span style="color: #008b8b;">34</span>) -&gt; <span style="color: #008b8b;">1</span>, x(<span style="color: #008b8b;">5</span>) -&gt; <span style="color: #008b8b;">0</span>),<span style="color: #008b8b;">Map</span>())

scala&gt; <span style="color: #a020f0;">for</span> (x <span style="color: #a020f0;">&lt;-</span> csp.variables) println(s<span style="color: #8b2252;">"</span><span style="color: #a0522d;">$x</span><span style="color: #8b2252;"> </span><span style="color: #a0522d;">${solution(x)}</span><span style="color: #8b2252;">"</span>)
x(<span style="color: #008b8b;">2</span>) <span style="color: #008b8b;">0</span>
x(<span style="color: #008b8b;">3</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">5</span>) <span style="color: #008b8b;">0</span>
x(<span style="color: #008b8b;">8</span>) <span style="color: #008b8b;">0</span>
x(<span style="color: #008b8b;">13</span>) <span style="color: #008b8b;">1</span>
x(<span style="color: #008b8b;">21</span>) <span style="color: #008b8b;">0</span>
x(<span style="color: #008b8b;">34</span>) <span style="color: #008b8b;">1</span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org0e8236a"></a>練習問題<br />
<div class="outline-text-4" id="text-6-1-1">
<ul class="org-ul">
<li>和が40の場合はどうなるか?</li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgad5e6e9" class="outline-3">
<h3 id="orgad5e6e9"><span class="section-number-3">6.2</span> 魔方陣</h3>
<div class="outline-text-3" id="text-6-2">
<pre class="example">
1から9の数字を 3×3 に配置し， 各行，各列，各対角線の和がいずれも15になるようにせよ．
</pre>

<ul class="org-ul">
<li>このような配置は魔方陣 (Magic square)と呼ばれる (<a href="http://ja.wikipedia.org/wiki/%E9%AD%94%E6%96%B9%E9%99%A3">Wikipedia:魔方陣</a>)．</li>
<li>以下のようにCSPとして定式化できる．</li>
</ul>

<blockquote>
<ul class="org-ul">
<li>\(X = \cup_{0 \le i,j \le 2} x_{i,j} \)
<ul class="org-ul">
<li>\(x_{0,0}, x_{0,1}, \ldots, x_{2,2}\)</li>
</ul></li>
<li>\(Dom\)
<ul class="org-ul">
<li>\(Dom(x_{i,j}) = \{1, 9\}\)</li>
</ul></li>
<li>\(C\)
<ul class="org-ul">
<li>\(alldiff(x_{0,0}, x_{0,1}, \ldots, x_{2,2})\)</li>
<li>\( x_{i,0} + x_{i,1} + x_{i,2} = 15 (i = 0, 1, 2) \)</li>
<li>\( x_{0,j} + x_{1,j} + x_{2,j} = 15 (j = 0, 1, 2) \)</li>
<li>\( x_{0,0} + x_{1,1} + x_{2,2} = 15 \)</li>
<li>\( x_{0,2} + x_{1,1} + x_{2,0} = 15 \)</li>
</ul></li>
</ul>
</blockquote>

<ul class="org-ul">
<li>ここで alldiff はCSPのグローバル制約の一つ Alldifferent 制約であり，与えられた引数が互いに異なることを表す．</li>
<li>すなわち alldiff(\(x_1, x_2, \ldots, x_n\)) は \(x_i \ne x_j\) (for all  \(i < j\)) と同じである．</li>
<li>CSPを記述したファイルは以下のようになる <a href="hoge/files/ex-magicsq.sc">ex-magicsq.sc</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span>

reset
int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">0</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>); int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">1</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>); int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">2</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>)
int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">0</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>); int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">1</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>); int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>)
int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">0</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>); int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">1</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>); int(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">2</span>), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>)
add(alldiff(
  <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">0</span>), <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">1</span>), <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">2</span>),
  <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">0</span>), <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">1</span>), <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>),
  <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">0</span>), <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">1</span>), <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">2</span>)
))
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">0</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">2</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">0</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">0</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">2</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">0</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">0</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">0</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">1</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">2</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">2</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">0</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">2</span>) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">0</span>,<span style="color: #008b8b;">2</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">1</span>) + <span style="color: #8b2252;">'x</span>(<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">0</span>) === <span style="color: #008b8b;">15</span>)
</pre>
</div>

<ul class="org-ul">
<li>ただこの書き方だともっと大きい魔方陣のプログラムを書くのは大変．</li>
<li>Scala の制御構造やクラスを利用すればもっと以下のように簡潔に記述できる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>, dsl.<span style="color: #a020f0;">_</span>

<span style="color: #a020f0;">val</span> <span style="color: #a0522d;">xs</span> <span style="color: #a020f0;">=</span> <span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>; j <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>) <span style="color: #a020f0;">yield</span> int(<span style="color: #8b2252;">'x</span>(i,j), <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">9</span>)
add(alldiff(xs))

<span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>)
  add(<span style="color: #008b8b;">Sum</span>((<span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>).map(j <span style="color: #a020f0;">=&gt;</span> <span style="color: #8b2252;">'x</span>(i,j))) === <span style="color: #008b8b;">15</span>)
<span style="color: #a020f0;">for</span> (j <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>)
  add(<span style="color: #008b8b;">Sum</span>((<span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>).map(i <span style="color: #a020f0;">=&gt;</span> <span style="color: #8b2252;">'x</span>(i,j))) === <span style="color: #008b8b;">15</span>)

add(<span style="color: #008b8b;">Sum</span>((<span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>).map(i <span style="color: #a020f0;">=&gt;</span> <span style="color: #8b2252;">'x</span>(i,i))) === <span style="color: #008b8b;">15</span>)
add(<span style="color: #008b8b;">Sum</span>((<span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">3</span>).map(i <span style="color: #a020f0;">=&gt;</span> <span style="color: #8b2252;">'x</span>(i,<span style="color: #008b8b;">4</span>-i))) === <span style="color: #008b8b;">15</span>)
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org1541355"></a>練習問題<br />
<div class="outline-text-4" id="text-6-2-1">
<ul class="org-ul">
<li>n x n の魔方陣を記述してみよう．</li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-org0c8eb9c" class="outline-3">
<h3 id="org0c8eb9c"><span class="section-number-3">6.3</span> 正方形矩形パッキング</h3>
<div class="outline-text-3" id="text-6-3">
<pre class="example">
正方形詰込み問題 SP(n,s) は一辺の長さ 1 から n まで1ずつ増加する正方形の集合を
一辺の長さ s の正方形の枠内に重なりなく配置する問題である．
</pre>



<div class="figure">
<p><img src="figs/spp15.png" alt="spp15.png" width="400px" />
</p>
</div>

<ul class="org-ul">
<li>最も素直なモデリングは整数変数 \(x_{i}, y_{i} \in \{0, \ldots, s-i\}\) をそれぞれの正方形 \(i~(1 \le i \le n)\) に \((x_{i},~y_{i})\) が正方形 \(i\) の左下の座標を指すようにするものである．</li>
<li>以下の制約は任意の二つの正方形 \(i\) と \(j\) (但し \(1\le i < j \le n\)) が重なることを禁止する．
<ul class="org-ul">
<li>\((x_{i}+i \le x_{j}) \vee (x_{j}+j \le x_{i}) \vee (y_{i}+i \le y_{j}) \vee (y_{j}+j \le y_{i})\)</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span> , dsl.<span style="color: #a020f0;">_</span>

<span style="color: #a020f0;">val</span> <span style="color: #a0522d;">n</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">15</span>
<span style="color: #a020f0;">val</span> <span style="color: #a0522d;">s</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">100</span>

<span style="color: #a020f0;">var</span> <span style="color: #ff0000; font-weight: bold;">lb</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">15</span>
<span style="color: #a020f0;">var</span> <span style="color: #ff0000; font-weight: bold;">ub</span> <span style="color: #a020f0;">=</span> s
int(<span style="color: #8b2252;">'m</span>, lb, ub)

<span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to n) { 
  int(<span style="color: #8b2252;">'x</span>(i),<span style="color: #008b8b;">0</span>,s-i) 
  int(<span style="color: #8b2252;">'y</span>(i),<span style="color: #008b8b;">0</span>,s-i) 
}

<span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to n)
  add((<span style="color: #8b2252;">'x</span>(i)+i &lt;= <span style="color: #8b2252;">'m</span>) &amp;&amp; (<span style="color: #8b2252;">'y</span>(i)+i &lt;= <span style="color: #8b2252;">'m</span>)) 

<span style="color: #a020f0;">for</span> (i <span style="color: #a020f0;">&lt;-</span> <span style="color: #008b8b;">1</span> to n; j <span style="color: #a020f0;">&lt;-</span> i+<span style="color: #008b8b;">1</span> to n) 
  add((<span style="color: #8b2252;">'x</span>(i)+i&lt;=<span style="color: #8b2252;">'x</span>(j)) || (<span style="color: #8b2252;">'x</span>(j)+j&lt;=<span style="color: #8b2252;">'x</span>(i)) || (<span style="color: #8b2252;">'y</span>(i)+i&lt;=<span style="color: #8b2252;">'y</span>(j)) || (<span style="color: #8b2252;">'y</span>(j)+j&lt;=<span style="color: #8b2252;">'y</span>(i)))

<span style="color: #a020f0;">while</span>(lb &lt;= ub &amp;&amp; find(<span style="color: #8b2252;">'m</span> &lt;= ub)) {
  add(<span style="color: #8b2252;">'m</span> &lt;= ub)
  ub -= <span style="color: #008b8b;">1</span>
  println(ub)
}
</pre>
</div>
<ul class="org-ul">
<li>最適化部分は1ずつ下げているが，もっと良い方法がある．</li>
</ul>
</div>
</div>

<div id="outline-container-org0f7a55f" class="outline-3">
<h3 id="org0f7a55f"><span class="section-number-3">6.4</span> その他の例題</h3>
<div class="outline-text-3" id="text-6-4">
<ul class="org-ul">
<li><a href="http://www.csplib.org/Problems/prob024/">ラングフォード・ペアリング</a></li>
<li>プログラム例は <a href="http://tsoh.org/scarab/examples.html">Scarab の Example</a> ページにある．</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge3f4ad9" class="outline-2">
<h2 id="orge3f4ad9"><span class="section-number-2">7</span> その他 Scarab の説明クラスとメソッドの簡単なまとめ</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgc01db61" class="outline-3">
<h3 id="orgc01db61"><span class="section-number-3">7.1</span> jar ファイルとソースコード</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>scarab を jar ファイルにまとめたものです</li>
<li>scala -cp scarab-v196-s212.jar などどすることで, scarab を利用できま
す</li>
<li>使用している Scala のバージョンに応じて，以下から適切な scarab jar
を選択してダウンロードしてください．
<ul class="org-ul">
<li>(for Scala 2.12.*) use <a href="jars/scarab-v196-s212.jar">jars/scarab-v196-s212.jar</a></li>
<li>(for Scala 2.11.*) use <a href="jars/scarab-v196-s211.jar">jars/scarab-v196-s211.jar</a></li>
<li>(for Scala 2.10.*) use <a href="jars/scarab-v196-s210.jar">jars/scarab-v196-s210.jar</a></li>
<li>ソースコードは <a href="https://github.com/TakehideSoh/Scarab">Github </a>から入手できます．</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgda479fe" class="outline-3">
<h3 id="orgda479fe"><span class="section-number-3">7.2</span> Scarab のクラスについて</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>Scarab のクラスについては scaladoc によって生成された <a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/">API</a> に詳し
い.</li>
<li><p>
代表的なものを以下に記述する．
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">クラス名</th>
<th scope="col" class="org-left">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/CSP.html">CSP</a></td>
<td class="org-left">制約充足問題 (CSP) のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Assignment.html">Assignment</a></td>
<td class="org-left">CSP への値割当てのクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Solver.html">Solver</a></td>
<td class="org-left">CSP ソルバーのクラス</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Term.html">Term</a></td>
<td class="org-left">制約を構成する項を表す抽象クラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Var.html">Var</a></td>
<td class="org-left">Term を継承する整数変数のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Sum.html">Sum</a></td>
<td class="org-left">Term を継承する項の和のクラス</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Constraint.html">Constraint</a></td>
<td class="org-left">制約を表す抽象クラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/And.html">And</a></td>
<td class="org-left">Constraint を継承するリテラルの連言のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Or.html">Or</a></td>
<td class="org-left">Constraint を継承するリテラルの選言のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Literal.html">Literal</a></td>
<td class="org-left">Constraint を継承するリテラルのクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Bool.html">Bool</a></td>
<td class="org-left">Literal を継承するブール変数のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/Not.html">Not</a></td>
<td class="org-left">Literal を継承するブール変数の否定のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/LeZero.html">LeZero</a></td>
<td class="org-left">Literal を継承する線形比較 \(b + \sum_i a_ix_i \le 0\) のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/GeZero.html">GeZero</a></td>
<td class="org-left">Literal を継承する線形比較 \(b + \sum_i a_ix_i \ge 0\) のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/EqZero.html">EqZero</a></td>
<td class="org-left">Literal を継承する線形比較 \(b + \sum_i a_ix_i = 0\) のクラス</td>
</tr>

<tr>
<td class="org-left"><a href="https://tsoh.org/scarab/docs/scarab-api/jp/kobe_u/scarab/NeZero.html">NeZero</a></td>
<td class="org-left">Literal を継承する線形比較 \(b + \sum_i a_ix_i \ne 0\) のクラス</td>
</tr>
</tbody>
</table></li>
<li>これらのクラスに加えて, Scarab DSL でグローバル制約 alldiff を利
用できるように以下のメソッドとして提供している (DSL ではトップレ
ベルで利用できる). 
<ul class="org-ul">
<li>def alldiff(xs: Iterable[Term]): And</li>
<li>def alldiff(xs: Term*): And</li>
</ul></li>
</ul>
</div>

<ol class="org-ol">
<li><a id="org9e755c7"></a>CSPに関係するクラス図<br />
<div class="outline-text-4" id="text-7-2-1">
<center>

<div class="figure">
<p><img src="figs/class_diagram_csp.png" alt="class_diagram_csp.png" />
</p>
</div>
</center>
</div>
</li>

<li><a id="org6355ca3"></a>制約ソルバーに関係するクラス図<br />
<div class="outline-text-4" id="text-7-2-2">
<center>

<div class="figure">
<p><img src="figs/class_diagram_solver.png" alt="class_diagram_solver.png" />
</p>
</div>
</center>
</div>
</li>
</ol>
</div>

<div id="outline-container-org5be2710" class="outline-3">
<h3 id="org5be2710"><span class="section-number-3">7.3</span> Scarab DSL について</h3>
<div class="outline-text-3" id="text-7-3">
</div>
<ol class="org-ol">
<li><a id="org5c0e671"></a>CSP について<br />
<div class="outline-text-4" id="text-7-3-1">
<ul class="org-ul">
<li>Scarab DSL を呼んだ状態, すなわち以下のように <code>import</code> 文を書いた
場合には, <code>csp</code> という名前のデフォルトの <code>csp</code> オブジェクトが定義さ
れている.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>, dsl.<span style="color: #a020f0;">_</span>
</pre>
</div>
<ul class="org-ul">
<li>この csp オブジェクトは以下のメソッドで編集できる.
<ul class="org-ul">
<li>整数変数の追加
<ul class="org-ul">
<li><code>def int(x: Var, a: Int, b: Int): Var</code></li>
<li><code>def int(x: Var, d: Seq[Int]): Var</code></li>
</ul></li>
<li>制約の追加
<ul class="org-ul">
<li><code>def add(c: Constraint): Constraint</code></li>
</ul></li>
</ul></li>
<li>これらのメソッドを呼ぶと, 暗黙的にデフォルトのオブジェクト csp
に対する操作になる</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; int(<span style="color: #8b2252;">'x</span>, <span style="color: #008b8b;">1</span>, <span style="color: #008b8b;">5</span>)
res<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> x

scala&gt; int(<span style="color: #8b2252;">'y</span>, <span style="color: #008b8b;">Seq</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">3</span>,<span style="color: #008b8b;">5</span>))
res<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> y

scala&gt; add(<span style="color: #8b2252;">'x</span> + <span style="color: #8b2252;">'y</span> &gt;= <span style="color: #008b8b;">3</span>)
res<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">GeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-3</span>+x+y))

scala&gt; csp
res<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">CSP</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">CSP</span>(<span style="color: #008b8b;">Vector</span>(x, y),<span style="color: #008b8b;">Vector</span>(),<span style="color: #008b8b;">Map</span>(x -&gt; <span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">1</span> to <span style="color: #008b8b;">5</span>), y -&gt; <span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">3</span>,<span style="color: #008b8b;">5</span>)),<span style="color: #008b8b;">Vector</span>(<span style="color: #008b8b;">GeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-3</span>+x+y))))
</pre>
</div>
</div>
</li>

<li><a id="org004c9b4"></a>CSP における整数変数の定義について<br />
<div class="outline-text-4" id="text-7-3-2">
<ul class="org-ul">
<li>Scarab DSL では, 整数変数の定義が簡単に行えるようにシンボルの暗
黙変換 (implicit conversion) を定義している.</li>
<li>以下は, 整数変数を通常の手続きで定義する方法である.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>, dsl.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> jp.kobe_u.scarab.<span style="color: #a020f0;">_</span>
<span style="color: #a020f0;">import</span> dsl.<span style="color: #a020f0;">_</span>

scala&gt; <span style="color: #008b8b;">Var</span>(<span style="color: #8b2252;">"x"</span>,<span style="color: #8b2252;">"1"</span>,<span style="color: #8b2252;">"2"</span>)
res<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> x(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>)
</pre>
</div>
<ul class="org-ul">
<li>ここで, <code>x(1,2)</code> はこの整数変数の変数名になる (変数名は重複があっ
てはならない).</li>
<li>Scala のシンボルはシングルクォーテーションを使って以下のように定
義される.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #8b2252;">'s</span>
res0<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Symbol</span> <span style="color: #a020f0;">=</span> <span style="color: #8b2252;">'s</span>
</pre>
</div>
<ul class="org-ul">
<li>暗黙変換は, オブジェクトをシンボルと解釈すると, エラーになるが,
CSPの整数変数と解釈するとうまくいく時に行われる.</li>
<li>以下は, そのような例である.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #8b2252;">'s</span>(<span style="color: #008b8b;">1</span>)
res1<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> s(<span style="color: #008b8b;">1</span>)
</pre>
</div>
<ul class="org-ul">
<li>ここで <code>'s(1)</code> の <code>'s~x をシンボルと解釈すると, シンボルは ~apply</code> メ
ソッド (Scala ではメソッド呼び出しの際に <code>apply</code> というメソッド名
を省略可能) を持たないため，エラーとなる.</li>
<li>しかし, Scarab DSL において, シンボルから整数変数オブジェクトへ
の暗黙変換が定義されているため, <code>'s</code> を整数変数として解釈すること
が試みられる．</li>
<li>結果として, 整数変数クラス (Var) が, <code>apply</code> メソッドを持ち, かつ
Int 型の引数を取ることが出来るため (実際はより幅広く任意個の Any
型を引数に取れる), <code>'s</code> は Var 型のオブジェクトと解釈され, <code>'s(1)</code>
は Var 型のオブジェクトのメソッド <code>apply</code> を引数 1 に対して呼んだ
と解釈される.</li>
<li>Var 型の <code>apply</code> メソッドは, &rsquo;s に引数1を追加した新しい Var 型のオ
ブジェクトを生成するファクトリメソッドになっているので, 最終的に
<code>s(1)</code> という名前の整数変数が返される.</li>
<li>以下は, Var 型オブジェクトを生成するいくつかの方法である.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #8b2252;">'s</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>)
res2<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> s(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>)

scala&gt; <span style="color: #8b2252;">'s</span>(<span style="color: #008b8b;">1</span>)(<span style="color: #008b8b;">2</span>)
res3<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> s(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>)

scala&gt; <span style="color: #8b2252;">'s</span>(<span style="color: #008b8b;">1</span>)(<span style="color: #008b8b;">2</span>)(<span style="color: #008b8b;">3</span>)
res4<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> s(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">3</span>)

scala&gt; <span style="color: #8b2252;">'s</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">3</span>)
res5<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> s(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">2</span>,<span style="color: #008b8b;">3</span>)
</pre>
</div>
<ul class="org-ul">
<li>&rsquo;s(1,2) と &rsquo;s(1)(2) の結果は同じになる．
<ul class="org-ul">
<li>&rsquo;s(1,2) は, apply メソッドを2個の引数で呼んでいる</li>
<li>&rsquo;s(1)(2) は, &rsquo;s(1) で生成されるオブジェクトに対してさらに apply
メソッドを呼んでいる.</li>
</ul></li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-org37a4d3e" class="outline-3">
<h3 id="org37a4d3e"><span class="section-number-3">7.4</span> Scarab DSL の制約記述に関する構文 (BNF記法)</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li><b>V</b>, <b>T</b>, <b>C</b>, <b>B</b> を <b>Var</b> (整数変数), <b>Term</b> (項), <b>Constraint</b> (制約), <b>Bool</b> (ブール変数) に対応するScarabオブジェクトとする.</li>
<li>Int, String, Any は Scala のオブジェクトとする．</li>
<li>制約に関する Scarab DSL の構文は BNF 記法を用いて以下のように定義される．</li>
</ul>
<pre class="example">
T  ::= V | -T | T + Int | T + T | T - Int | T - T | T * Int | Sum(V, ...) | Sum(Seq(V, ...))  
V  ::= Var(String, String, ...) | V(Any, ...)
C  ::= B | T op T | !C | C &amp;&amp; C | C || C | alldiff(Seq(T, ...)) |  
      And(C, ...) | And(Seq(C, ...)) | Or(C, ...) | Or(Seq(C, ...))
op ::= &lt;= | &lt; | =&gt; | &gt; | === | !==
B  ::= Bool(String, String, ...) | B(Any, ...)
</pre>
</div>
</div>

<div id="outline-container-org8a2d1ed" class="outline-3">
<h3 id="org8a2d1ed"><span class="section-number-3">7.5</span> プログラムの簡単なまとめ</h3>
<div class="outline-text-3" id="text-7-5">
</div>
<ol class="org-ol">
<li><a id="org4cba4ed"></a>項オブジェクト (Termオブジェクト)<br />
<ol class="org-ol">
<li><a id="orgbb2d96a"></a>整数変数オブジェクト (Varオブジェクト)<br />
<div class="outline-text-5" id="text-7-5-1-1">
<ul class="org-ul">
<li>整数変数オプジェクトは Var で生成する． 引数にはその名前を与える．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">val</span> <span style="color: #a0522d;">x</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Var</span>(<span style="color: #8b2252;">"x"</span>)
x<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> x
</pre>
</div>
<ul class="org-ul">
<li>名前がない場合は，新しい匿名変数オブジェクトが生成される．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #a020f0;">val</span> <span style="color: #a0522d;">z</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Var</span>()
z<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">TMP_I_1</span>
</pre>
</div>
<ul class="org-ul">
<li>Varオブジェクトに添字を与えることで，新しいVarオブジェクトを生成できる． 添字には整数や文字列を使用でき，また複数与えても良い． ただし，添字にScarabの整数変数を用いることはできない．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; x(<span style="color: #8b2252;">"book"</span>, <span style="color: #8b2252;">"apple"</span>, <span style="color: #008b8b;">300</span>)
res16<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> x(book,apple,<span style="color: #008b8b;">300</span>)
</pre>
</div>
<ul class="org-ul">
<li>Scala の Symbol は，Varオブジェクトに暗黙変換される．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">pscala&gt; <span style="color: #8b2252;">'abc</span>(<span style="color: #008b8b;">2</span>)
res19<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> abc(<span style="color: #008b8b;">2</span>)
</pre>
</div>
<ul class="org-ul">
<li>Varオブジェクトは後述の項 (Term) オブジェクトの一種である．</li>
</ul>
</div>
</li>

<li><a id="orgf8c8a33"></a>加算オブジェクト (Sumオブジェクト)<br />
<div class="outline-text-5" id="text-7-5-1-2">
<ul class="org-ul">
<li>Sumオブジェクトは整数変数 (項も) の加算 (\(+\))，減算 (\(-\)) を表す．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #008b8b;">Sum</span>(<span style="color: #8b2252;">'x</span> + <span style="color: #8b2252;">'y</span>)
res21<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Sum</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Sum</span>(+x+y)

scala&gt; <span style="color: #008b8b;">Sum</span>(- <span style="color: #8b2252;">'x</span> - <span style="color: #8b2252;">'y</span>)
res22<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Sum</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Sum</span>(-x-y)

scala&gt; - <span style="color: #008b8b;">Sum</span>(- <span style="color: #8b2252;">'x</span> - <span style="color: #8b2252;">'y</span>)
res23<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Sum</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Sum</span>(+x+y)
</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org8ebaa1f"></a>制約オブジェクト<br />
<div class="outline-text-4" id="text-7-5-2">
<ul class="org-ul">
<li>Termオブジェクトと比較演算子 &lt;= (\(\le\)), &lt;, &gt;= (\(\ge\)), &gt;, <code>=</code> (\(=\)),　!== (\(\ne\)) の組合せで構成される．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; <span style="color: #008b8b;">Sum</span>(<span style="color: #8b2252;">'x</span> - <span style="color: #8b2252;">'y</span>) &lt;= <span style="color: #008b8b;">3</span>
res25<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">LeZero</span>(<span style="color: #008b8b;">Sum</span>(<span style="color: #008b8b;">-3</span>+x-y))
</pre>
</div>
<ul class="org-ul">
<li>宣言されると同時に &lt;= 0 の形に正規化される．</li>
</ul>
</div>
</li>

<li><a id="orgd3bd876"></a>CSPオブジェクト<br />
<div class="outline-text-4" id="text-7-5-3">
<ul class="org-ul">
<li>CSPオブジェクトは，制約充足問題を表すオブジェクトである． jp.kobe_u.scarab.dsl._ を import した場合， デフォールトのCSPオブジェクトを変数 csp として参照できる．</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org37be7e8"></a>整数変数の宣言 (CSPへ整数変数を追加)<br />
<div class="outline-text-5" id="text-7-5-3-1">
<ul class="org-ul">
<li>整数変数は int メソッドで宣言する． 通常は，下限値と上限値を与える．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; int(<span style="color: #8b2252;">'x</span>, <span style="color: #008b8b;">0</span>, <span style="color: #008b8b;">10</span>)
res27<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> x
</pre>
</div>
<ul class="org-ul">
<li>飛び飛びのドメインも利用できる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; int(<span style="color: #8b2252;">'y</span>, <span style="color: #008b8b;">Seq</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">3</span>,<span style="color: #008b8b;">5</span>))
res28<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Var</span> <span style="color: #a020f0;">=</span> y
</pre>
</div>
<ul class="org-ul">
<li>変数のドメインは，csp.dom メソッドで確認できる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; csp.dom(<span style="color: #8b2252;">'x</span>)
res29<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Domain</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>)

scala&gt; csp.dom(<span style="color: #8b2252;">'y</span>)
res30<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Domain</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">3</span>,<span style="color: #008b8b;">5</span>)
</pre>
</div>
</div>
</li>

<li><a id="org0e4a5ee"></a>制約の追加<br />
<div class="outline-text-5" id="text-7-5-3-2">
<ul class="org-ul">
<li>制約の追加は add メソッドで宣言する．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; add(<span style="color: #8b2252;">'x</span> === <span style="color: #8b2252;">'y</span> * <span style="color: #008b8b;">2</span>)
res31<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Constraint</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(+x-2*y))
</pre>
</div>
<ul class="org-ul">
<li>現時点での変数宣言と制約は show で確認できる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; show
int(x,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">0</span> to <span style="color: #008b8b;">10</span>))
int(y,<span style="color: #008b8b;">Domain</span>(<span style="color: #008b8b;">1</span>,<span style="color: #008b8b;">3</span>,<span style="color: #008b8b;">5</span>))
<span style="color: #008b8b;">EqZero</span>(<span style="color: #008b8b;">Sum</span>(+x-2*y))
</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orga4869ec"></a>解の探索<br />
<div class="outline-text-4" id="text-7-5-4">
<ul class="org-ul">
<li>最初の解の探索は find で行う．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; find
res34<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">true</span>
</pre>
</div>
<ul class="org-ul">
<li>結果が true なら解が存在し，false なら存在しない． 見つかった解は solution で表示される．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; solution
res35<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Assignment</span>(<span style="color: #008b8b;">Map</span>(x -&gt; <span style="color: #008b8b;">10</span>, y -&gt; <span style="color: #008b8b;">5</span>),<span style="color: #008b8b;">Map</span>())
</pre>
</div>
<ul class="org-ul">
<li>変数を solution への引数として与えれば，値が得られる．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; solution(<span style="color: #8b2252;">'x</span>)
res37<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Int</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">10</span>
</pre>
</div>
<ul class="org-ul">
<li>find メソッド中では，以下が実行されている．
<ul class="org-ul">
<li>CSPオブジェクトをSAT符号化し，SATソルバーへ節を追加</li>
<li>SATソルバーによる解探索を実行</li>
<li>SATソルバーが発見した解をCSPの解に復号化</li>
</ul></li>
<li>次の解は findNext で求める．</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">scala&gt; findNext
res38<span style="color: #a020f0;">:</span> <span style="color: #228b22;">Boolean</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">true</span>

scala&gt; solution
res39<span style="color: #a020f0;">:</span> <span style="color: #228b22;">jp</span>.kobe_u.scarab.<span style="color: #008b8b;">Assignment</span> <span style="color: #a020f0;">=</span> <span style="color: #008b8b;">Assignment</span>(<span style="color: #008b8b;">Map</span>(x -&gt; <span style="color: #008b8b;">6</span>, y -&gt; <span style="color: #008b8b;">3</span>),<span style="color: #008b8b;">Map</span>())
</pre>
</div>
<ul class="org-ul">
<li>findNextメソッド中では，以下が実行されている．
<ul class="org-ul">
<li>現在の解の否定を表す条件をソルバーに追加</li>
<li>追加したCNFに対し，SATソルバーによる解探索を実行</li>
<li>SATソルバーの発見した解をCSPの解に復号化</li>
</ul></li>
</ul>
</div>
</li>

<li><a id="org1fba731"></a>その他<br />
<div class="outline-text-4" id="text-7-5-5">
<ul class="org-ul">
<li>SATソルバーを切り替えるには以下のようにする</li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">use(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Sat4jPB</span>)
use(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">ExtSatSolver</span>(<span style="color: #8b2252;">"minisat"</span>))
</pre>
</div>
<ul class="org-ul">
<li>外部SATソルバー (ExtSatSolver) の引数には実行パスを入れる．</li>
<li>エンコーダを切り替えるには以下のようにする
<ul class="org-ul">
<li>デフォルトは OrderEncoder</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-scala">use(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">NativePBEncoder</span>(csp, satSolver))
use(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">LogEncoder</span>(csp, satSolver))
</pre>
</div>
<ul class="org-ul">
<li>各種符号化・機能とSatSolverの対応表は以下になる．</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">Sat4j</th>
<th scope="col" class="org-left">Sat4jPB</th>
<th scope="col" class="org-left">ExtSolver</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">OrderEncoder</td>
<td class="org-left">o</td>
<td class="org-left">o</td>
<td class="org-left">o</td>
</tr>

<tr>
<td class="org-left">LogEncorder</td>
<td class="org-left">o</td>
<td class="org-left">o</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-left">NativePBEncoder</td>
<td class="org-left">o</td>
<td class="org-left">o</td>
<td class="org-left">x</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">インクリメンタルSAT</td>
<td class="org-left">o</td>
<td class="org-left">o</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-left">仮説</td>
<td class="org-left">o</td>
<td class="org-left">o</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-left">極小非充足コア</td>
<td class="org-left">o</td>
<td class="org-left">x</td>
<td class="org-left">x</td>
</tr>
</tbody>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Takehide Soh</p>
<p class="date">Created: 2019-04-26 金 14:32</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
